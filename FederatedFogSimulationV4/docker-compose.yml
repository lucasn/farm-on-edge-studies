version: "3.7"
name: simulation

services:
  fog:
    build: fog/
    networks:
      - fog-network
    environment:
      - BROKER_IP=${BROKER_IP}
      - BROKER_PORT=${BROKER_PORT}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    deploy:
      mode: replicated
      replicas: ${QUANTITY_FOGS}
    depends_on:
      - "mosquitto"

  cloud:
    build: cloud/
    networks:
      - fog-network
    depends_on:
      - "mosquitto"

  mosquitto:
    container_name: mosquitto
    image: eclipse-mosquitto:2
    volumes:
      - ./mosquitto/:/mosquitto/config/:ro
    ports:
      - 1883:1883
      - 9001:9001
    networks:
      - fog-network

  client:
    build: client/
    networks:
      - fog-network
    environment:
      - BROKER_IP=${BROKER_IP}
      - BROKER_PORT=${BROKER_PORT}
      - QUANTITY_CLIENTS=${QUANTITY_CLIENTS}
    depends_on:
      - "fog"
    
  data_collector:
    container_name: data
    build: data_collector/
    networks:
      - fog-network
    environment:
      - NUMBER_OF_FOGS=${QUANTITY_FOGS}
      - BROKER_IP=${BROKER_IP}
      - BROKER_PORT=${BROKER_PORT}
      - SIMULATION_TIME=${SIMULATION_TIME}
    volumes:
      - ./data_collector:/data_collector
    depends_on:
      - "fog"

networks:
  fog-network:
    driver: bridge
    name: fog-network